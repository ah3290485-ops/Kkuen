<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>لوحة الأدمن</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  background:#050814;
  font-family:Arial;
  color:#fff;
  margin:0;
  padding:0;
}
header{
  background:#0d132b;
  padding:15px;
  text-align:center;
  color:gold;
  font-size:20px;
}
.section{
  padding:15px;
}
.card{
  background:#0d132b;
  padding:15px;
  border-radius:14px;
  margin-bottom:15px;
  box-shadow:0 0 10px rgba(255,215,0,.2);
}
button{
  padding:8px 14px;
  border:none;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}
.approve{background:gold;color:#000;}
.reject{background:#ff4d4d;color:#fff;}
.logout{
  width:100%;
  margin-top:20px;
  background:#ff4d4d;
  color:#fff;
}
small{color:#aaa;}
</style>
</head>

<body>

<header>لوحة تحكم الأدمن</header>

<div class="section">
  <h3>طلبات الشحن</h3>
  <div id="deposits"></div>

  <h3>طلبات السحب</h3>
  <div id="withdrawals"></div>

  <button class="logout" onclick="logout()">تسجيل خروج</button>
</div>

<script>
const SUPABASE_URL = "https://gpfxakuneeuafxgqbobs.supabase.co";
const SUPABASE_ANON_KEY = "PUT_YOUR_ANON_KEY_HERE";

const supabase = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

// تحقق من تسجيل الدخول
async function checkAdmin(){
  const { data:{ user } } = await supabase.auth.getUser();
  if(!user){
    window.location.href="login.html";
  }
}
checkAdmin();

// تحميل طلبات الشحن
async function loadDeposits(){
  const { data, error } = await supabase
    .from("deposits")
    .select("*")
    .order("created_at",{ascending:false});

  if(error) return;

  document.getElementById("deposits").innerHTML = "";

  data.forEach(d=>{
    document.getElementById("deposits").innerHTML += `
      <div class="card">
        <b>المبلغ:</b> ${d.amount}$<br>
        <b>TXID:</b> ${d.txid}<br>
        <b>الحالة:</b> ${d.status}<br>
        <small>${d.created_at}</small><br><br>

        ${d.status==="pending" ? `
          <button class="approve" onclick="approveDeposit('${d.id}','${d.user_id}',${d.amount})">موافقة</button>
        ` : ""}
      </div>
    `;
  });
}

// الموافقة على الشحن
async function approveDeposit(id,userId,amount){
  await supabase.from("deposits")
    .update({status:"approved"})
    .eq("id",id);

  await supabase.from("profiles")
    .update({ balance: supabase.rpc("increment",{x:amount}) })
    .eq("user_id",userId);

  alert("تمت الموافقة على الشحن");
  loadDeposits();
}

// تحميل طلبات السحب
async function loadWithdrawals(){
  const { data } = await supabase
    .from("withdrawals")
    .select("*")
    .order("created_at",{ascending:false});

  document.getElementById("withdrawals").innerHTML = "";

  data.forEach(w=>{
    document.getElementById("withdrawals").innerHTML += `
      <div class="card">
        <b>المبلغ:</b> ${w.amount}$<br>
        <b>المحفظة:</b> ${w.wallet}<br>
        <b>الحالة:</b> ${w.status}<br>
        <small>${w.created_at}</small>
      </div>
    `;
  });
}

// تسجيل خروج
async function logout(){
  await supabase.auth.signOut();
  window.location.href="login.html";
}

loadDeposits();
loadWithdrawals();
</script>

</body>
</html>
