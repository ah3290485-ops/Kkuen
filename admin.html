<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="mobile.css">

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    .status-pending { color: orange; }
    .status-approved { color: #22c55e; }
    .status-rejected { color: #ef4444; }
    .actions button {
      margin: 5px;
    }
  </style>
</head>

<body>

<div class="container">
  <h1>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h1>
  <div id="adminEmail" style="opacity:.7;margin-bottom:10px"></div>

  <div id="withdrawList"></div>

  <button class="btn-dark" onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script src="supabase.js"></script>
<script>
/* ğŸ” Ø¶Ø¹ Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø· */
const ADMIN_EMAIL = "am.alsus1995@gmail.com";

async function checkAdmin() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user || user.email !== ADMIN_EMAIL) {
    alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„");
    location.href = "dashboard.html";
    return;
  }
  document.getElementById("adminEmail").innerText = user.email;
}

async function loadWithdrawals() {
  const { data, error } = await supabase
    .from("withdrawals")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    alert("Ø®Ø·Ø£ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    return;
  }

  const list = document.getElementById("withdrawList");
  list.innerHTML = "";

  if (!data || data.length === 0) {
    list.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨</p>";
    return;
  }

  data.forEach(w => {
    list.innerHTML += `
      <div class="card">
        <p><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${w.user_id}</p>
        <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${w.amount}</p>
        <p><strong>Ø§Ù„Ù…Ø­ÙØ¸Ø©:</strong> ${w.wallet}</p>
        <p>
          <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong>
          <span class="status-${w.status}">${w.status}</span>
        </p>

        ${
          w.status === "pending"
          ? `
            <div class="actions">
              <button class="btn-gold" onclick="updateStatus('${w.id}','approved')">âœ”ï¸ Ù‚Ø¨ÙˆÙ„</button>
              <button class="btn-dark" onclick="updateStatus('${w.id}','rejected')">âŒ Ø±ÙØ¶</button>
            </div>
          `
          : ""
        }
      </div>
    `;
  });
}

async function updateStatus(id, status) {
  const confirmAction = confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ");
  if (!confirmAction) return;

  const { error } = await supabase
    .from("withdrawals")
    .update({ status: status })
    .eq("id", id);

  if (error) {
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£");
  } else {
    loadWithdrawals();
  }
}

async function logout() {
  await supabase.auth.signOut();
  location.href = "login.html";
}

checkAdmin();
loadWithdrawals();
</script>

</body>
</html>
