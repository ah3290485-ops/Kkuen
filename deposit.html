<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</title>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>

  <style>
    :root{
      --bg1:#020617;
      --bg2:#0f172a;
      --card:#0b1220cc;
      --border:#1e293b;
      --gold:#f59e0b;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --danger:#ef4444;
      --ok:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh;
      padding:16px 16px 92px;
    }
    .container{
      max-width: 520px;
      margin: 0 auto;
    }
    .title{
      font-size: 28px;
      font-weight: 800;
      margin: 6px 0 8px;
    }
    .sub{
      color:var(--muted);
      margin:0 0 14px;
      line-height:1.6;
      font-size:14px;
    }
    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      margin-bottom:12px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#0b1220;
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      width:100%;
      word-break:break-all;
      font-size:14px;
    }
    .btn{
      width:100%;
      padding:14px 14px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      font-weight:800;
      font-size:16px;
    }
    .btn-gold{ background: var(--gold); color:#0b1220; }
    .btn-dark{ background:#111827; color:var(--text); border:1px solid var(--border); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    label{
      display:block;
      margin: 10px 0 6px;
      color: var(--muted);
      font-size: 13px;
    }
    input{
      width:100%;
      padding:14px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0b1220;
      color:var(--text);
      font-size:16px;
      outline:none;
    }
    input:focus{ border-color:#334155; }
    .hint{
      margin-top:8px;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }
    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      font-size:14px;
      display:none;
    }
    .msg.ok{ display:block; border-color: #14532d; background:#052e16; color:#bbf7d0; }
    .msg.err{ display:block; border-color: #7f1d1d; background:#450a0a; color:#fecaca; }

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--border);
      font-size:14px;
    }
    th,td{
      padding:10px;
      border-bottom:1px solid var(--border);
      text-align:right;
      vertical-align:top;
    }
    th{ color:var(--muted); font-weight:700; background:#0b1220; }
    tr:last-child td{ border-bottom:none; }
    .status{
      font-weight:800;
      padding:6px 10px;
      border-radius:999px;
      display:inline-block;
      font-size:12px;
      border:1px solid var(--border);
      background:#0b1220;
    }
    .pending{ color: var(--gold); }
    .approved{ color: var(--ok); }
    .rejected{ color: var(--danger); }

    /* Bottom menu */
    .menu{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: rgba(2,6,23,.92);
      border-top: 1px solid var(--border);
      padding: 10px 8px;
      display:flex;
      justify-content: space-around;
      backdrop-filter: blur(10px);
    }
    .menu a{
      color:var(--text);
      text-decoration:none;
      text-align:center;
      font-size:12px;
      width: 20%;
    }
    .menu a span{
      display:block;
      font-size:22px;
      margin-bottom:4px;
    }
    .active{ color: var(--gold) !important; }
  </style>
</head>

<body>
  <div class="container">
    <div class="title">Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</div>
    <p class="sub">
      Ø§Ù„Ø´Ø­Ù† Ø­Ø§Ù„ÙŠØ§Ù‹ <b>ÙŠØ¯ÙˆÙŠ</b>. Ø§Ù†Øª Ø§Ø¨Ø¹Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù†ÙƒØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø¯Ø®Ù‘Ù„ <b>TXID</b> ÙˆØ§Ù„Ù…Ø¨Ù„ØºØŒ ÙˆØ±Ø­ ÙŠÙ†Ø¶Ø§Ù Ø·Ù„Ø¨Ùƒ Ø¨Ø­Ø§Ù„Ø© <b>pending</b>.
    </p>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div id="userEmail" style="opacity:.9; font-weight:700"></div>
        <button class="btn btn-dark" style="width:auto; padding:10px 12px" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:800; margin-bottom:10px;">ğŸ“¥ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø­Ù†</div>

      <!-- ØºÙŠÙ‘Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‡ÙˆÙ† Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸ØªÙƒ -->
      <div class="pill" id="depositAddress">
        TRC20 USDT: <b id="addrText">PUT_YOUR_USDT_TRC20_ADDRESS_HERE</b>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn btn-dark" onclick="copyAddr()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</button>
      </div>

      <div class="hint">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ Ø¨Ø¯Ùƒ Ø´Ø­Ù† Ø¨Ø¹Ù…Ù„Ø© ØªØ§Ù†ÙŠØ© (BTC Ù…Ø«Ù„Ø§Ù‹) Ø®Ø¨Ø±Ù†ÙŠ ÙˆØ¨Ø¹Ù…Ù„Ù‡Ø§ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù‚Ø§Ø¦Ù…Ø©.
      </div>
    </div>

    <div class="card">
      <div style="font-weight:800; margin-bottom:8px;">ğŸ§¾ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø´Ø­Ù†</div>

      <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
      <input id="amount" type="number" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 100" min="1" />

      <label>TXID / Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
      <input id="txid" type="text" placeholder="Ø§Ù„ØµÙ‚Ù‡ Ù…Ù† Ù…Ø­ÙØ¸ØªÙƒ" />

      <button id="submitBtn" class="btn btn-gold" style="margin-top:12px" onclick="submitDeposit()">
        âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
      </button>

      <div id="msgBox" class="msg"></div>
    </div>

    <div class="card">
      <div style="font-weight:800; margin-bottom:10px;">ğŸ“Œ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø®Ø§ØµØ© ÙÙŠÙƒ</div>
      <div id="listWrap">
        <div class="hint">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
    </div>
  </div>

  <div class="menu">
    <a href="dashboard.html"><span>ğŸ </span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="ads.html"><span>ğŸ¬</span>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</a>
    <a href="wallet.html"><span>ğŸ’¼</span>Ù…Ø­ÙØ¸ØªÙŠ</a>
    <a href="account.html"><span>ğŸ‘¤</span>Ø­Ø³Ø§Ø¨ÙŠ</a>
    <a class="active" href="deposit.html"><span>â•</span>Ø´Ø­Ù†</a>
  </div>

<script>
  let currentUser = null;

  async function init() {
    // ØªØ­Ù‚Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    const { data } = await supabase.auth.getUser();
    currentUser = data?.user;

    if (!currentUser) {
      window.location.href = "login.html";
      return;
    }

    document.getElementById("userEmail").textContent = currentUser.email || "";
    await loadMyDeposits();
  }

  async function logout() {
    await supabase.auth.signOut();
    window.location.href = "login.html";
  }

  function setMsg(type, text){
    const box = document.getElementById("msgBox");
    box.className = "msg " + (type === "ok" ? "ok" : "err");
    box.textContent = text;
  }

  function copyAddr(){
    const addr = document.getElementById("addrText").textContent.trim();
    navigator.clipboard.writeText(addr).then(()=>{
      setMsg("ok","âœ… ØªÙ… Ù†Ø³Ø® Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø­Ù†");
      setTimeout(()=>{ document.getElementById("msgBox").style.display="none"; }, 1500);
      document.getElementById("msgBox").style.display="block";
    }).catch(()=>{
      setMsg("err","âŒ Ù…Ø§ Ù‚Ø¯Ø±Øª Ø§Ù†Ø³Ø®ØŒ Ø§Ù†Ø³Ø®Ù‡ ÙŠØ¯ÙˆÙŠ");
      document.getElementById("msgBox").style.display="block";
    });
  }

  function statusBadge(s){
    const st = (s || "pending").toLowerCase();
    let cls = "pending", label = "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";
    if(st === "approved"){ cls="approved"; label="Ù…Ù‚Ø¨ÙˆÙ„"; }
    if(st === "rejected"){ cls="rejected"; label="Ù…Ø±ÙÙˆØ¶"; }
    return `<span class="status ${cls}">${label}</span>`;
  }

  async function loadMyDeposits(){
    const wrap = document.getElementById("listWrap");
    wrap.innerHTML = `<div class="hint">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;

    const { data, error } = await supabase
      .from("deposits")
      .select("amount, txid, status, created_at")
      .eq("user_id", currentUser.id)
      .order("created_at", { ascending: false });

    if (error) {
      wrap.innerHTML = `<div class="hint">âŒ ÙÙŠ Ù…Ø´ÙƒÙ„Ø© Ø¨Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Policies (RLS).</div>`;
      return;
    }

    if (!data || data.length === 0){
      wrap.innerHTML = `<div class="hint">Ù…Ø§ Ø¹Ù†Ø¯Ùƒ Ø·Ù„Ø¨Ø§Øª Ø´Ø­Ù† Ù„Ø­Ø¯ Ø§Ù„Ø¢Ù†.</div>`;
      return;
    }

    const rows = data.map(r=>{
      const dt = new Date(r.created_at);
      const when = isNaN(dt.getTime()) ? "" : dt.toLocaleString();
      return `
        <tr>
          <td>${statusBadge(r.status)}</td>
          <td>${Number(r.amount || 0)}</td>
          <td style="word-break:break-all">${r.txid || ""}</td>
          <td>${when}</td>
        </tr>
      `;
    }).join("");

    wrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th>TXID</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  async function submitDeposit(){
    const btn = document.getElementById("submitBtn");
    const amountEl = document.getElementById("amount");
    const txidEl = document.getElementById("txid");
    const amount = Number(amountEl.value);
    const txid = (txidEl.value || "").trim();

    document.getElementById("msgBox").style.display="block";

    if (!amount || amount < 1){
      setMsg("err","âŒ Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
      return;
    }
    if (txid.length < 6){
      setMsg("err","âŒ TXID Ù‚ØµÙŠØ±ØŒ Ù„ØµÙ‚ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„");
      return;
    }

    btn.disabled = true;
    btn.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

    // 1) Ø¥Ø¯Ø®Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†
    const { error: insErr } = await supabase
      .from("deposits")
      .insert([{
        user_id: currentUser.id,
        amount: amount,
        txid: txid,
        status: "pending"
      }]);

    if (insErr){
      btn.disabled = false;
      btn.textContent = "âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨";
      setMsg("err","âŒ Ù…Ø§ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ØºØ§Ù„Ø¨Ø§Ù‹ Policies Ù†Ø§Ù‚ØµØ© Ù„Ù„Ù€ deposits.");
      return;
    }

    // 2) Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) - Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ø¬Ø¯ÙˆÙ„ transactions
    // Ù„Ùˆ Ù…Ø§ Ø¹Ù†Ø¯Ùƒ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ùˆ ÙÙŠÙ‡ RLS Ø¨ÙŠØ·Ù„Ø¹ Ø®Ø·Ø£ØŒ Ù…Ø§ Ø±Ø­ Ù†Ø®Ø±Ø¨ Ø´ÙŠ.
    await supabase.from("transactions").insert([{
      user_id: currentUser.id,
      type: "deposit_request",
      amount: Math.round(amount)
    }]);

    setMsg("ok","âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†. Ø±Ø­ ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.");
    amountEl.value = "";
    txidEl.value = "";

    await loadMyDeposits();

    btn.disabled = false;
    btn.textContent = "âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨";
  }

  init();
</script>
</body>
</html>
```î¨0î¨‚
